// ðŸ“š LEXIPOP PRISMA SCHEMA
// Vocabulary learning game with scores, leaderboard, and quiz data

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Vocabulary words for the quiz
model Word {
  id                   Int      @id @default(autoincrement())
  word                 String   @unique
  correctDefinition    String
  incorrectDefinition1 String
  incorrectDefinition2 String
  incorrectDefinition3 String

  // Metadata
  difficulty     Int     @default(1) // 1-5 scale
  category       String? // e.g., 'academic', 'business', 'science'
  sourceLanguage String  @default("english")
  partOfSpeech   String? // noun, verb, adjective, etc.

  // Analytics
  timesShown           Int   @default(0)
  timesCorrect         Int   @default(0)
  averageResponseTime  Float? // milliseconds

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastShown DateTime?

  // Relations
  questionResponses QuestionResponse[]

  @@map("words")
}

// Game sessions - each completed game
model GameSession {
  id       String @id @default(cuid())
  gameId   String @unique
  userFid  Int

  // Game results
  score          Int
  totalQuestions Int
  streak         Int   @default(0)
  accuracy       Float // percentage

  // Timing
  gameStartTime DateTime
  gameEndTime   DateTime
  totalDuration Int // milliseconds

  // Rewards
  tokensEarned    Int   @default(0)
  bonusMultiplier Float @default(1)

  // Metadata
  createdAt DateTime @default(now())

  // Relations
  questionResponses QuestionResponse[]
  userStats         UserStats?         @relation(fields: [userFid], references: [userFid])

  @@map("game_sessions")
}

// Individual question responses within a game
model QuestionResponse {
  id            Int    @id @default(autoincrement())
  gameSessionId String
  wordId        Int

  // Response data
  selectedAnswer String
  isCorrect      Boolean
  responseTime   Int // milliseconds
  questionOrder  Int // 1-5 within game

  // Context - JSON array of all 4 shuffled options
  shuffledOptions String // JSON string

  // Timestamp
  answeredAt DateTime @default(now())

  // Relations
  gameSession GameSession @relation(fields: [gameSessionId], references: [id])
  word        Word        @relation(fields: [wordId], references: [id])

  @@map("question_responses")
}

// User statistics and leaderboard data
model UserStats {
  id      Int @id @default(autoincrement())
  userFid Int @unique

  // Overall performance
  totalGamesPlayed        Int @default(0)
  totalQuestionsAnswered  Int @default(0)
  totalCorrectAnswers     Int @default(0)

  // Best scores for leaderboard
  highestScore       Int   @default(0)
  longestStreak      Int   @default(0)
  bestAccuracy       Float @default(0)
  fastestAverageTime Float? // milliseconds

  // Tokens and rewards
  totalTokensEarned Int @default(0)
  totalSpins        Int @default(0)

  // Wallet connection
  walletAddress String? @unique // Primary wallet address for this user

  // Streaks and achievements
  currentDailyStreak Int @default(0)
  longestDailyStreak Int @default(0)
  lastPlayedDate     DateTime?

  // Difficulty progression
  currentDifficultyLevel Int @default(1)
  wordsLearned           Int @default(0) // unique words answered correctly

  // Notification fields
  notificationToken           String?
  notificationUrl             String?
  notificationsEnabled        Boolean @default(false)
  lastNotificationInteraction DateTime? // Track when user last opened a notification

  // Timestamps
  firstGameAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  gameSessions GameSession[]
  tokenClaims  TokenClaim[]

  @@map("user_stats")
}

// Word categories for organization
model Category {
  id              Int     @id @default(autoincrement())
  name            String  @unique
  description     String?
  difficultyRange String? // e.g., "1-3" for beginner categories
  wordCount       Int     @default(0)
  isActive        Boolean @default(true)

  createdAt DateTime @default(now())

  @@map("categories")
}

// Token claims tracking for onchain data
model TokenClaim {
  id              Int      @id @default(autoincrement())

  // Claim identifiers
  transactionHash String?  @unique // Onchain transaction hash
  gameSessionId   String?  // Link to game that earned these tokens
  nonce          String?   // Unique nonce used for claim

  // User & wallet info
  userFid        Int?
  walletAddress  String   // Recipient wallet address

  // Token details
  tokenAmount    BigInt   // Amount in wei (18 decimals)
  tokenAmountFormatted Float // Human readable amount

  // Claim status
  status         String   @default("pending") // pending, signature_generated, claimed, failed
  signatureGenerated DateTime? // When signature was created
  claimedAt      DateTime?     // When actually claimed onchain

  // Onchain data (populated after sync)
  blockNumber    Int?
  gasUsed        BigInt?

  // Error tracking
  errorMessage   String?

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  userStats      UserStats? @relation(fields: [userFid], references: [userFid])

  @@index([walletAddress])
  @@index([transactionHash])
  @@index([status])
  @@index([claimedAt])
  @@map("token_claims")
}

// Import batches for tracking bulk vocabulary uploads
model ImportBatch {
  id          Int    @id @default(autoincrement())
  batchName   String
  description String?

  // Import stats
  totalWords        Int @default(0)
  successfulImports Int @default(0)
  failedImports     Int @default(0)
  duplicatesSkipped Int @default(0)

  // Metadata
  sourceFile String?
  importedBy String? // admin user identifier
  status     String  @default("pending") // pending, processing, completed, failed

  // Timestamps
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  @@map("import_batches")
}

// Simple weekly leaderboard scores
model LeaderboardScore {
  id           Int      @id @default(autoincrement())
  userFid      Int      // Farcaster user ID
  username     String   // Farcaster username
  displayName  String?  // Farcaster display name
  pfpUrl       String?  // Farcaster profile picture URL
  score        Int      // Base: 0-500 (100 per correct answer), can be higher with streak bonuses
  weekStarting DateTime // Monday of the week at 00:00:00
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Only one score per user per week (upsert if better)
  @@unique([userFid, weekStarting])
  @@map("leaderboard_scores")
}